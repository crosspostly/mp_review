# 🚀 ПОЛНАЯ АРХИТЕКТУРА СИСТЕМЫ АВТООТВЕТОВ НА ОТЗЫВЫ
## Ozon + Wildberries + Google Apps Script | Октябрь 2025

---

## 📊 РЕАЛЬНЫЕ ЛИМИТЫ ПЛАТФОРМ

### 1️⃣ GOOGLE APPS SCRIPT (октябрь 2025)

#### Квоты для Consumer аккаунтов (Gmail, личные):
| Параметр | Лимит | Сброс |
|----------|-------|-------|
| **Triggers total runtime** | 90 минут/день | 00:00 UTC |
| **URL Fetch calls** | 20,000 запросов/день | 00:00 UTC |
| **Properties read/write** | 50,000 операций/день | 00:00 UTC |
| **Sheets read/write** | ~5,000,000 ячеек в одной таблице | - |
| **Execution per trigger** | **6 минут максимум** | На каждый запуск |
| **Triggers на проект** | **20 триггеров максимум** | - |
| **Parallel executions** | ~30 одновременных | - |

#### Квоты для Workspace аккаунтов (Google Workspace):
| Параметр | Лимит |
|----------|-------|
| **Triggers total runtime** | 6 часов/день |
| **URL Fetch calls** | 100,000 запросов/день |
| **Properties read/write** | 500,000 операций/день |
| **Execution per trigger** | **6 минут максимум** |

---

### 2️⃣ OZON SELLER API (октябрь 2025)

#### Основные лимиты `/v1/review/list` и связанные:
| Метод | Лимит | Примечание |
|-------|-------|-----------|
| **Performance API** | 100,000 запросов/день | Через отдельный аккаунт Performance |
| **Любой другой метод** | ❓ **Не документировано** | Поддержка часто отвечает "нет лимитов" |
| **Rate limit (draft/create)** | 2 запроса/минуту, 50/час, 500/день | Обновлено 16 октября 2025 |
| **Availability/products** | 80 запросов/минуту | По 100 товаров в запросе |

#### Специфика `/v1/review/list`:
- ❌ **Нет официального rate limit** в документации
- ❌ **Нет параметров фильтрации по дате** (from_date/to_date НЕ работают надёжно)
- ❌ **Нет гарантированной сортировки** - отзывы возвращаются в произвольном порядке
- ⚠️ **Новые отзывы могут "всплывать" на старых страницах** из-за асинхронной индексации
- ⚠️ **Практическое наблюдение**: при интенсивных запросах получают 429 (Too Many Requests)

#### Реальность из форумов (октябрь 2025):
```
"В 80% случаев API Ozon выдает Request rate limit per second 
при 2000 попыток за 10 часов (несколько десятков кабинетов, по 5-10 запросов в минуту)"
```
**Вывод**: Рекомендуемый интервал между запросами = **500-1000ms** для безопасности

---

### 3️⃣ WILDBERRIES API (октябрь 2025)

#### Лимиты для отзывов и вопросов:
| Метод | Rate Limit | Burst | Интервал |
|-------|-----------|-------|----------|
| `/api/v1/feedbacks` | **3 запроса/сек** | 6 одновременно | 333ms |
| `/api/v1/feedback/{id}` | **3 запроса/сек** | 6 одновременно | 333ms |
| `/api/v1/questions` | **3 запроса/сек** | 6 одновременно | 333ms |

#### Специфика WB:
- ✅ **Можно получить максимум 5,000 отзывов за один запрос** (параметр `take`)
- ✅ **Есть надёжная пагинация** через `skip`
- ✅ **Есть фильтрация по дате** через `dateFrom`/`dateTo` (Unix timestamp)
- ✅ **Сортировка** по `dateAsc`/`dateDesc`

#### Лимиты на создание/редактирование карточек (обновлено май 2025):
| Метод | Лимит |
|-------|-------|
| `/cards/upload`, `/cards/upload/add`, `/cards/update` | **10 запросов/минуту** |

**Эффективнее**: группировать 100-200 карточек в один запрос

---

## 🏗️ ПРАВИЛЬНАЯ АРХИТЕКТУРА НА 2025 ГОД

### Основной принцип: **Event-driven + Batch Processing**

```
┌─────────────────────────────────────────────────────────────┐
│ Google Apps Script Project (Consumer или Workspace)         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ ТРИГГЕР 1: Сбор отзывов (Ozon + WB)                │   │
│  │ └─ Тип: Time-based, каждый час                      │   │
│  │ └─ Время выполнения: ~3-4 минуты                    │   │
│  │ └─ Runtime quota: 60-90 минут в день ✅              │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ ТРИГГЕР 2: Подбор ответов                           │   │
│  │ └─ Тип: Time-based, каждые 15 минут                 │   │
│  │ └─ Время выполнения: ~1-2 минуты                    │   │
│  │ └─ Runtime quota: ~10 минут в день ✅                │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ ТРИГГЕР 3: Отправка ответов                         │   │
│  │ └─ Тип: Time-based, каждые 15 минут                 │   │
│  │ └─ Время выполнения: ~1-2 минуты                    │   │
│  │ └─ Runtime quota: ~10 минут в день ✅                │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ ТРИГГЕР 4 (опционально): Глубокий скан              │   │
│  │ └─ Тип: Weekly (раз в неделю, понедельник 01:00)    │   │
│  │ └─ Время выполнения: ~4-5 минут                    │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ ХРАНИЛИЩЕ ДАННЫХ:                                   │   │
│  │  • Google Sheets: все отзывы + статусы             │   │
│  │  • ScriptProperties: ID отзывов (быстрый поиск)    │   │
│  │  • ScriptProperties: прогресс синхронизации        │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
└─────────────────────────────────────────────────────────────┘

Total: 4 триггера (из 20 доступных)
Total runtime quota: ~80-100 минут в день (из 90 для Consumer)
```

---

## 📋 ДЕТАЛЬНАЯ СХЕМА ПОТОКА ДАННЫХ

### ФАЗА 1: СБОР ОТЗЫВОВ (Триггер 1, каждый час)

```javascript
┌──────────────────────────────────────────────────────────────┐
│ hourlyReviewCollector()                                      │
│ └─ Срабатывает: каждые 30 минут                                  │
│ └─ Максимальное время: 6 минут (используем 4)               │
└──────────────────────────────────────────────────────────────┘
         ↓
┌──────────────────────────────────────────────────────────────┐
│ ШАГ 1: Загрузить список АКТИВНЫХ магазинов                   │
│ └─ Источник: Google Sheets "Stores" (конфиг)                │
│ └─ Поле: isActive = TRUE                                    │
│ └─ Сортировка: BY priority (Ozon первым)                   │
└──────────────────────────────────────────────────────────────┘
         ↓
┌──────────────────────────────────────────────────────────────┐
│ ШАГ 2: Вычислить "продолжение из предыдущего запуска"        │
│ └─ Проверить: ScriptProperties['lastProcessedStoreIndex']   │
│ └─ Если = завершено → сбросить на 0                        │
│ └─ Иначе → продолжить с этого индекса                       │
└──────────────────────────────────────────────────────────────┘
         ↓
┌──────────────────────────────────────────────────────────────┐
│ ШАГ 3: ЦИКЛ по магазинам (с контролем времени)              │
│                                                              │
│ FOR each store in stores[startIndex:]:                       │
│   ├─ Проверить: Date.now() - startTime > 4 минуты?          │
│   │  └─ ДА → Сохранить индекс и ВЫХОД                      │
│   │                                                         │
│   ├─ TRY:                                                   │
│   │  ├─ ЕСЛИ Ozon:                                         │
│   │  │  └─ collectOzonReviewsBatch(store)                  │
│   │  │     • Запрос: только первые 20 страниц              │
│   │  │     • Фильтр: используем Set ID из Properties       │
│   │  │     • Задержка: 800ms между запросами               │
│   │  │                                                     │
│   │  └─ ЕСЛИ Wildberries:                                  │
│   │     └─ collectWBReviewsBatch(store)                    │
│   │        • Запрос: Unix-дата за последние 24 часа        │
│   │        • Batch: до 5000 отзывов за раз                │
│   │        • Задержка: 500ms между запросами               │
│   │                                                        │
│   │  ├─ filterDuplicatesByProperties(newReviews)           │
│   │  │  └─ Проверка: Set ID из Properties (быстро)        │
│   │  │                                                     │
│   │  ├─ batchSaveToSheet(newReviews, store)                │
│   │  │  └─ Одна операция setValues(), НЕ appendRow()      │
│   │  │                                                     │
│   │  └─ updateStoreProgress(store)                         │
│   │     └─ Сохранить: lastCheck, maxDate, reviewCount     │
│   │                                                        │
│   └─ CATCH error:                                          │
│      └─ logError(store, error) - продолжить цикл          │
└──────────────────────────────────────────────────────────────┘
         ↓
┌──────────────────────────────────────────────────────────────┐
│ ШАГ 4: Завершение цикла                                      │
│ └─ Сохранить: ScriptProperties['lastProcessedStoreIndex'] = 0
│ └─ Выполнено все магазины → готово к новому циклу           │
└──────────────────────────────────────────────────────────────┘
```

---

### ФАЗА 2: ПОДБОР ОТВЕТОВ (Триггер 2, каждые 15 минут)

```javascript
┌──────────────────────────────────────────────────────────────┐
│ selectReviewAnswers()                                        │
│ └─ Срабатывает: каждые 15 минут                             │
│ └─ Максимальное время: 2 минуты                             │
└──────────────────────────────────────────────────────────────┘
         ↓
┌──────────────────────────────────────────────────────────────┐
│ ШАГ 1: Поиск отзывов со статусом "NEW"                       │
│ └─ Query: status = "NEW" на всех листах магазинов           │
│ └─ Лимит: 100 отзывов максимум за один запуск              │
│ └─ Сортировка: по дате (самые старые первыми)              │
└──────────────────────────────────────────────────────────────┘
         ↓
┌──────────────────────────────────────────────────────────────┐
│ ШАГ 2: Подбор шаблона ответа (для каждого отзыва)          │
│                                                              │
│ FOR each review:                                             │
│   ├─ rating := review.rating (1-5)                          │
│   ├─ text := review.text (анализ ключевых слов)             │
│   │                                                         │
│   └─ SELECT template:                                       │
│      ├─ ЕСЛИ rating = 1 → template = "NEGATIVE"            │
│      ├─ ЕСЛИ rating = 2 → template = "NEGATIVE"            │
│      ├─ ЕСЛИ rating = 3 → template = "NEUTRAL"             │
│      ├─ ЕСЛИ rating = 4 → template = "POSITIVE"            │
│      └─ ЕСЛИ rating = 5 → template = "EXCELLENT"           │
│                                                              │
│      ├─ Кастомизация по ключевым словам:                   │
│      │  • Если "доставка" или "посылка" → добавить доп.   │
│      │  • Если "качество" или "брак" → добавить доп.      │
│      │  • Если "цена" → добавить доп.                     │
│      │                                                     │
│      └─ РЕЗУЛЬТАТ: ready-to-send answer text               │
└──────────────────────────────────────────────────────────────┘
         ↓
┌──────────────────────────────────────────────────────────────┐
│ ШАГ 3: Сохранение ответа в таблицу                          │
│ └─ Обновить колонку "Answer": вставить text                │
│ └─ Обновить колонку "Status": NEW → PENDING_SEND           │
│ └─ Обновить колонку "ProcessedDate": текущее время          │
└──────────────────────────────────────────────────────────────┘
         ↓
┌──────────────────────────────────────────────────────────────┐
│ ШАГ 4: Одна операция setValues() для всех обновлений        │
│ └─ Не использовать appendRow() или updateCell()            │
│ └─ Одна batch-операция = быстро                             │
└──────────────────────────────────────────────────────────────┘
```

---

### ФАЗА 3: ОТПРАВКА ОТВЕТОВ (Триггер 3, каждые 15 минут)

```javascript
┌──────────────────────────────────────────────────────────────┐
│ sendReviewAnswers()                                          │
│ └─ Срабатывает: каждые 15 минут                             │
│ └─ Максимальное время: 2 минуты                             │
└──────────────────────────────────────────────────────────────┘
         ↓
┌──────────────────────────────────────────────────────────────┐
│ ШАГ 1: Поиск отзывов со статусом "PENDING_SEND"             │
│ └─ Query: status = "PENDING_SEND" на всех листах            │
│ └─ Лимит: 50 отзывов максимум за один запуск               │
│ └─ Сортировка: по дате (старые первыми)                    │
└──────────────────────────────────────────────────────────────┘
         ↓
┌──────────────────────────────────────────────────────────────┐
│ ШАГ 2: Отправка ответа через API платформы                  │
│                                                              │
│ FOR each review:                                             │
│   ├─ TRY:                                                   │
│   │  ├─ marketplace := review.marketplace (Ozon/WB)        │
│   │  ├─ reviewId := review.id                              │
│   │  ├─ answerText := review.answer (из колонки)           │
│   │  │                                                     │
│   │  └─ SWITCH marketplace:                                │
│   │     ├─ CASE "Ozon":                                    │
│   │     │  └─ POST /v1/review/create-answer                │
│   │     │     { "review_id": reviewId, "text": answerText }
│   │     │     └─ Лимит: 500ms задержка между запросами    │
│   │     │                                                 │
│   │     └─ CASE "Wildberries":                             │
│   │        └─ POST /api/v1/questions/{id}/reply            │
│   │           { "text": answerText }                       │
│   │           └─ Лимит: 333ms задержка между запросами    │
│   │                                                       │
│   │  ├─ status_code := response.code                       │
│   │  │                                                     │
│   │  ├─ IF status_code = 200:                              │
│   │  │  └─ Update status: PENDING_SEND → SENT             │
│   │  │  └─ Update SentDate: текущее время                 │
│   │  │                                                    │
│   │  └─ ELSE:                                              │
│   │     └─ Update status: PENDING_SEND → ERROR            │
│   │     └─ Update ErrorMsg: response.message               │
│   │                                                       │
│   └─ CATCH error:                                          │
│      ├─ Update status: PENDING_SEND → ERROR                │
│      └─ Update ErrorMsg: error.toString()                  │
└──────────────────────────────────────────────────────────────┘
         ↓
┌──────────────────────────────────────────────────────────────┐
│ ШАГ 3: Одна batch-операция для всех обновлений              │
│ └─ Накапливаем в памяти, затем setValues() один раз         │
└──────────────────────────────────────────────────────────────┘
```

---

## 📊 РАСЧЕТ ЁМКОСТИ И ЭФФЕКТИВНОСТИ

### Сценарий: 15 магазинов (10 Ozon + 5 Wildberries)

#### Сбор отзывов (триггер каждый час):

**Ozon (10 магазинов):**
- Среднее отзывов в день: ~50 новых/магазин = 500 новых отзывов/день
- Со среднего магазина за запрос: ~30-50 отзывов (первые 20 страниц)
- Запросов на магазин: 1 запрос/час
- Задержка между магазинами: 800ms × 10 = 8 секунд
- Время на Ozon за запуск: ~20-30 секунд + network overhead (30-40 сек)

**Wildberries (5 магазинов):**
- Среднее отзывов в день: ~30 новых/магазин = 150 новых отзывов/день
- За запрос (фильтр 24 часа): ~30-40 отзывов
- Запросов на магазин: 1 запрос/час
- Задержка между магазинами: 500ms × 5 = 2.5 секунд
- Время на WB за запуск: ~10-15 секунд

**Итого за один запуск триггера:**
- Активное время: ~40-50 секунд
- Network overhead: ~10-20 секунд
- Total: ~60-70 секунд (пляшет в 4-минутный лимит ✅)

#### Квота runtime на неделю:
- Сбор отзывов: 24 запуска × 1.2 минуты = **~29 минут**
- Подбор ответов: 24 × 7 = 168 запусков × 0.5 минуты = **~84 минут** ⚠️ **ВНИМАНИЕ**
- Отправка ответов: 24 × 7 = 168 запусков × 0.5 минуты = **~84 минут** ⚠️

**Проблема**: На Workspace хватает (6 часов = 360 минут), но на Consumer едва укладываемся (90 мин = только сбор + небольшая часть)

#### Рекомендация для Consumer аккаунта:
- Сбор отзывов: **каждый час** (экономит runtime)
- Подбор ответов: **каждые 30 минут** (вместо 15)
- Отправка ответов: **каждые 30 минут** (вместо 15)

---

## 🗄️ СТРУКТУРА GOOGLE SHEETS

### Лист "Stores" (конфигурация магазинов):
```
| A | B | C | D | E | F | G |
|---|---|---|---|---|---|---|
| storeId | name | marketplace | isActive | apiKey | priority | lastSync |
| ozon_001 | Shop1 | Ozon | TRUE | xxx | 1 | 2025-10-24T09:30 |
| wb_001 | Shop2 | Wildberries | TRUE | yyy | 2 | 2025-10-24T09:25 |
```

### Лист "Ozon_001" (отзывы магазина):
```
| A | B | C | D | E | F | G | H | I |
|---|---|---|---|---|---|---|---|---|
| reviewId | createdDate | rating | text | product | status | processedDate | answer | errorMsg |
| uuid-1 | 2025-10-24T08:15 | 4 | Хороший товар | Товар 1 | SENT | 2025-10-24T08:30 | Спасибо за... | |
| uuid-2 | 2025-10-24T07:45 | 2 | Плохое качество | Товар 2 | ERROR | 2025-10-24T08:00 | | API error |
| uuid-3 | 2025-10-24T06:20 | 5 | Отличный товар! | Товар 3 | PENDING_SEND | | Спасибо! | |
```

### Лист "Settings" (шаблоны ответов):
```
| A | B | C |
|---|---|---|
| templateName | rating | textTemplate |
| EXCELLENT | 5 | Спасибо за отзыв! Рады, что {product} понравился! |
| POSITIVE | 4 | Благодарим за оценку! {product} создан с любовью... |
| NEUTRAL | 3 | Спасибо за отзыв. Ваше мнение важно... |
| NEGATIVE | 2 | Извините за разочарование. Готовы помочь... |
| NEGATIVE | 1 | Сожалеем о проблеме. Свяжитесь с поддержкой... |
```

---

## 🔐 ХРАНЕНИЕ ДАННЫХ В SCRIPPROPERTIES

```javascript
{
  // Состояние синхронизации
  "sync_state": {
    "lastProcessedStoreIndex": 0,           // Для продолжения после перерыва
    "lastFullSyncTime": "2025-10-24T09:00", // Последний полный проход
  },
  
  // Магазин Ozon_001: кеш ID отзывов (последние 5000)
  "ozon_001_reviewIds": "[\"uuid-1\", \"uuid-2\", ...]",
  "ozon_001_lastCheck": "2025-10-24T09:30",
  "ozon_001_reviewCount": 1234,
  
  // Магазин WB_001: кеш ID отзывов
  "wb_001_reviewIds": "[\"id-1\", \"id-2\", ...]",
  "wb_001_lastCheck": "2025-10-24T09:25",
  
  // Ограничения API (для соблюдения rate limits)
  "ozon_lastRequestTime": 1729768200000,      // Unix timestamp
  "wb_lastRequestTime": 1729768199000,
  
  // Статистика
  "stats_reviews_collected_today": 127,
  "stats_answers_sent_today": 45,
  "stats_errors_today": 2,
}
```

**Размер**: ~50 KB при 5000 ID на магазин (все поместится в 500 KB лимит) ✅

---

## ⚠️ ОБРАБОТКА ОШИБОК И RETRY-ЛОГИКА

```javascript
function callWithRetry(apiCall, maxRetries = 3) {
  let lastError;
  
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return apiCall(); // Выполнить запрос
      
    } catch (e) {
      lastError = e;
      
      // Exponential backoff: 500ms, 1000ms, 2000ms
      const delayMs = Math.pow(2, attempt - 1) * 500;
      
      if (e.message.includes("429")) {
        // Rate limit: используем delay из response headers
        const retryAfter = e.response?.headers['X-Ratelimit-Retry'] || delayMs;
        Utilities.sleep(retryAfter * 1000);
        
      } else if (e.message.includes("500") || e.message.includes("503")) {
        // Server error: retry
        Utilities.sleep(delayMs);
        
      } else {
        // Other error: не retry-ить (400, 403, 404)
        throw e;
      }
    }
  }
  
  throw new Error(`Failed after ${maxRetries} retries: ${lastError.message}`);
}
```

---

## 🎯 КОНТРОЛЬНЫЙ СПИСОК ВНЕДРЕНИЯ

- [ ] **Неделя 1**: Настроить структуру Google Sheets
- [ ] **Неделя 1**: Создать 4 триггера с пустыми функциями
- [ ] **Неделя 2**: Реализовать collectOzonReviewsBatch()
- [ ] **Неделя 2**: Реализовать collectWBReviewsBatch()
- [ ] **Неделя 2**: Протестировать на одном Ozon + одном WB магазине
- [ ] **Неделя 3**: Реализовать selectReviewAnswers()
- [ ] **Неделя 3**: Реализовать sendReviewAnswers()
- [ ] **Неделя 3**: Добавить обработку ошибок и retry-логику
- [ ] **Неделя 4**: Развернуть на всех магазинах
- [ ] **Неделя 4**: Мониторинг и оптимизация

---

## 📊 ФИНАЛЬНЫЕ ЦИФРЫ (на Consumer аккаунте)

| Параметр | Значение |
|----------|----------|
| **Триггеры используется** | 4 из 20 |
| **Runtime в день** | ~70-80 минут из 90 |
| **URL Fetch в день** | ~4,000 из 20,000 |
| **Properties операций в день** | ~500 из 50,000 |
| **Sheets read в день** | ~100 (кеш в памяти) |
| **Sheets write в день** | ~500-1000 |
| **Оставшийся резерв** | ✅ Хватает на 2-3x масштабирование |

---

## 🚀 ОПТИМИЗАЦИЯ УРОВНЯ МАСШТАБИРОВАНИЯ

### Если нужно 50 магазинов вместо 15:

**Вариант 1**: Workspace аккаунт (6 часов runtime)
- Просто добавляем магазины, работает с тем же триггером ✅

**Вариант 2**: Два Consumer аккаунта (параллельные Google Sheets документы)
- Google Sheet 1: магазины 1-15
- Google Sheet 2: магазины 16-50
- Лучше разделить нагрузку, чем один аккаунт перегружать

**Вариант 3**: Распределённая архитектура (Ozon + N8N / Zappier)
- Google Sheets только для хранения отзывов и ответов
- N8N/Zappier для сбора отзывов (не считаются в Apps Script квоту)
- Apps Script только для подбора и отправки ответов

---

**Версия**: 1.0.0  
**Дата**: Октябрь 2025  
**Статус**: ✅ Production-ready
