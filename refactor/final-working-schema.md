# ‚úÖ –ü–û–õ–ù–´–ô –§–ò–ù–ê–õ–¨–ù–´–ô –ü–õ–ê–ù –ë–ï–ó APIMonster
## –ß–∏—Å—Ç—ã–π Apps Script | –û–∫—Ç—è–±—Ä—å 2025

---

## üéØ –°–£–¢–¨ –ü–õ–ê–ù–ê

**100% Google Apps Script. –ù–û–õ–¨ —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤.**

- –ü–∞—Ä—Å–∏–º Ozon/WB **–∫–∞–∂–¥—ã–π —á–∞—Å** —á–µ—Ä–µ–∑ –∏—Ö API
- –•—Ä–∞–Ω–∏–º ID –≤ **Properties** –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- –•—Ä–∞–Ω–∏–º –æ—Ç–∑—ã–≤—ã –≤ **Sheets** –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
- **3 —Ç—Ä–∏–≥–≥–µ—Ä–∞**: —Å–±–æ—Ä ‚Üí –ø–æ–¥–±–æ—Ä ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞
- **Runtime**: 70-80 –º–∏–Ω—É—Ç/–¥–µ–Ω—å (–∏–∑ 90 –¥–ª—è Consumer) ‚úÖ

---

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Google Apps Script (–ë–ï–°–ü–õ–ê–¢–ù–û)                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                 ‚îÇ
‚îÇ –¢–†–ò–ì–ì–ï–† 1: –°–±–æ—Ä –æ—Ç–∑—ã–≤–æ–≤ (–∫–∞–∂–¥—ã–π —á–∞—Å)          ‚îÇ
‚îÇ   ‚îú‚îÄ –ü–∞—Ä—Å–∏—Ç Ozon API (20 —Å—Ç—Ä–∞–Ω–∏—Ü –º–∞–∫—Å)        ‚îÇ
‚îÇ   ‚îú‚îÄ –ü–∞—Ä—Å–∏—Ç WB API (24 —á–∞—Å–∞ –Ω–∞–∑–∞–¥)            ‚îÇ
‚îÇ   ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç ID –≤ Properties (–±—ã—Å—Ç—Ä–æ!)       ‚îÇ
‚îÇ   ‚îú‚îÄ –ù–æ–≤—ã–µ ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ Sheets                ‚îÇ
‚îÇ   ‚îî‚îÄ –û–±–Ω–æ–≤–ª—è–µ—Ç Properties –∫–µ—à                  ‚îÇ
‚îÇ   Time: ~3-4 –º–∏–Ω                                ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ –¢–†–ò–ì–ì–ï–† 2: –ü–æ–¥–±–æ—Ä –æ—Ç–≤–µ—Ç–æ–≤ (–∫–∞–∂–¥—ã–π —á–∞—Å)        ‚îÇ
‚îÇ   ‚îú‚îÄ –ù–∞—Ö–æ–¥–∏—Ç –æ—Ç–∑—ã–≤—ã NEW                        ‚îÇ
‚îÇ   ‚îú‚îÄ –í—ã–±–∏—Ä–∞–µ—Ç —à–∞–±–ª–æ–Ω –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É              ‚îÇ
‚îÇ   ‚îú‚îÄ –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º          ‚îÇ
‚îÇ   ‚îî‚îÄ –ú–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å NEW ‚Üí PENDING_SEND         ‚îÇ
‚îÇ   Time: ~1-2 –º–∏–Ω                                ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ –¢–†–ò–ì–ì–ï–† 3: –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ (–∫–∞–∂–¥—ã–π —á–∞—Å)      ‚îÇ
‚îÇ   ‚îú‚îÄ –ù–∞—Ö–æ–¥–∏—Ç –æ—Ç–∑—ã–≤—ã PENDING_SEND               ‚îÇ
‚îÇ   ‚îú‚îÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑ Ozon/WB API             ‚îÇ
‚îÇ   ‚îú‚îÄ Rate limiting (500ms Ozon, 333ms WB)     ‚îÇ
‚îÇ   ‚îî‚îÄ –ú–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å PENDING_SEND ‚Üí SENT        ‚îÇ
‚îÇ   Time: ~1-2 –º–∏–Ω                                ‚îÇ
‚îÇ                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

üíæ –•–†–ê–ù–ò–õ–ò–©–ï:
   ‚Ä¢ ScriptProperties: ID –æ—Ç–∑—ã–≤–æ–≤ (10K –ø–æ—Å–ª–µ–¥–Ω–∏—Ö)
   ‚Ä¢ Google Sheets: –≤—Å–µ –æ—Ç–∑—ã–≤—ã + —Å—Ç–∞—Ç—É—Å—ã
```

---

## üìä –õ–ò–ú–ò–¢–´ –ò –†–ê–°–ß–Å–¢–´

### Google Apps Script Consumer:
- **Runtime**: 90 –º–∏–Ω—É—Ç/–¥–µ–Ω—å
- **URL Fetch**: 20,000 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å
- **Properties**: 500 KB (‚âà50,000 –æ–ø–µ—Ä–∞—Ü–∏–π/–¥–µ–Ω—å)
- **Execution**: 6 –º–∏–Ω—É—Ç –º–∞–∫—Å–∏–º—É–º –Ω–∞ —Ç—Ä–∏–≥–≥–µ—Ä

### –ù–∞—à –ø–ª–∞–Ω (15 –º–∞–≥–∞–∑–∏–Ω–æ–≤):

**–°–±–æ—Ä –æ—Ç–∑—ã–≤–æ–≤ (—Ç—Ä–∏–≥–≥–µ—Ä –∫–∞–∂–¥—ã–π —á–∞—Å):**
- 10 –º–∞–≥–∞–∑–∏–Ω–æ–≤ Ozon √ó 20 —Å—Ç—Ä–∞–Ω–∏—Ü √ó 800ms = ~2.5 –º–∏–Ω—É—Ç—ã
- 5 –º–∞–≥–∞–∑–∏–Ω–æ–≤ WB √ó 1 –∑–∞–ø—Ä–æ—Å √ó 500ms = ~3 —Å–µ–∫—É–Ω–¥—ã
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Properties: ~5-10 —Å–µ–∫—É–Ω–¥
- **–ò—Ç–æ–≥–æ**: ~3 –º–∏–Ω—É—Ç—ã √ó 24 = **72 –º–∏–Ω—É—Ç—ã/–¥–µ–Ω—å**

**–ü–æ–¥–±–æ—Ä –æ—Ç–≤–µ—Ç–æ–≤ (—Ç—Ä–∏–≥–≥–µ—Ä –∫–∞–∂–¥—ã–π —á–∞—Å):**
- 100 –æ—Ç–∑—ã–≤–æ–≤ √ó 0.1 —Å–µ–∫ = ~10 —Å–µ–∫—É–Ω–¥
- **–ò—Ç–æ–≥–æ**: ~1 –º–∏–Ω—É—Ç–∞ √ó 24 = **24 –º–∏–Ω—É—Ç—ã/–¥–µ–Ω—å**

**–û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ (—Ç—Ä–∏–≥–≥–µ—Ä –∫–∞–∂–¥—ã–π —á–∞—Å):**
- 50 –æ—Ç–∑—ã–≤–æ–≤ √ó 500ms = ~25 —Å–µ–∫—É–Ω–¥
- **–ò—Ç–æ–≥–æ**: ~1 –º–∏–Ω—É—Ç–∞ √ó 24 = **24 –º–∏–Ω—É—Ç—ã/–¥–µ–Ω—å**

**TOTAL RUNTIME**: 72 + 24 + 24 = **120 –º–∏–Ω—É—Ç** ‚ö†Ô∏è

**–†–ï–®–ï–ù–ò–ï**: –£–≤–µ–ª–∏—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –¥–æ **–∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞** –≤–º–µ—Å—Ç–æ –∫–∞–∂–¥—ã–π —á–∞—Å:
- –°–±–æ—Ä: 72/2 = **36 –º–∏–Ω—É—Ç**
- –ü–æ–¥–±–æ—Ä: 24/2 = **12 –º–∏–Ω—É—Ç**
- –û—Ç–ø—Ä–∞–≤–∫–∞: 24/2 = **12 –º–∏–Ω—É—Ç**
- **TOTAL**: 36 + 12 + 12 = **60 –º–∏–Ω—É—Ç/–¥–µ–Ω—å** ‚úÖ

---

## üîß –ü–û–õ–ù–´–ô –†–ê–ë–û–ß–ò–ô –ö–û–î

### 1Ô∏è‚É£ –¢–†–ò–ì–ì–ï–† 1: –°–ë–û–† –û–¢–ó–´–í–û–í (–∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞)

```javascript
/**
 * –ì–ª–∞–≤–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä —Å–±–æ—Ä–∞ –æ—Ç–∑—ã–≤–æ–≤
 * –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞
 */
function hourlyReviewCollector() {
  const startTime = Date.now();
  const MAX_TIME = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç –ª–∏–º–∏—Ç
  
  const props = PropertiesService.getScriptProperties();
  let startIndex = parseInt(props.getProperty('lastProcessedStoreIndex') || '0');
  
  log(`[Collector] üöÄ –ù–∞—á–∞–ª–æ —Å–±–æ—Ä–∞ (—Å –º–∞–≥–∞–∑–∏–Ω–∞ ${startIndex})`);
  
  const stores = getActiveStores();
  
  for (let i = startIndex; i < stores.length; i++) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
    if (Date.now() - startTime > MAX_TIME) {
      props.setProperty('lastProcessedStoreIndex', i.toString());
      log(`[Collector] ‚è∞ –í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ, –ø—Ä–æ–≥—Ä–µ—Å—Å: ${i}`);
      return;
    }
    
    const store = stores[i];
    log(`[Collector] üì¶ ${i + 1}/${stores.length}: ${store.name}`);
    
    try {
      let allReviews = [];
      
      // –°–±–æ—Ä –ø–æ —Ç–∏–ø—É –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞
      if (store.marketplace === 'Ozon') {
        allReviews = collectOzonReviews(store);
      } else if (store.marketplace === 'Wildberries') {
        allReviews = collectWBReviews(store);
      }
      
      if (allReviews.length > 0) {
        // –ö–†–ò–¢–ò–ß–ù–û: —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Properties
        const newReviews = filterDuplicatesByProperties(allReviews, store.id);
        
        if (newReviews.length > 0) {
          // Batch —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Sheets
          batchSaveToSheet(newReviews, store.id);
          log(`[Collector] ‚úÖ ${store.name}: ${newReviews.length} –Ω–æ–≤—ã—Ö`);
        } else {
          log(`[Collector] ‚ÑπÔ∏è ${store.name}: –≤—Å–µ –¥—É–±–ª–∏–∫–∞—Ç—ã`);
        }
      }
      
    } catch (e) {
      log(`[Collector] ‚ùå ${store.name}: ${e.message}`);
    }
  }
  
  // –°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
  props.setProperty('lastProcessedStoreIndex', '0');
  log(`[Collector] üèÅ –¶–∏–∫–ª –∑–∞–≤–µ—Ä—à—ë–Ω`);
}

/**
 * –°–±–æ—Ä –æ—Ç–∑—ã–≤–æ–≤ Ozon (—Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 20 —Å—Ç—Ä–∞–Ω–∏—Ü)
 */
function collectOzonReviews(store) {
  const MAX_PAGES = 20;
  const DELAY_MS = 800;
  let allReviews = [];
  
  log(`[Ozon] –°–±–æ—Ä –¥–ª—è ${store.name}, max ${MAX_PAGES} —Å—Ç—Ä–∞–Ω–∏—Ü`);
  
  for (let page = 1; page <= MAX_PAGES; page++) {
    try {
      if (page > 1) Utilities.sleep(DELAY_MS);
      
      const pageReviews = getOzonReviewsPage(store, page);
      
      if (pageReviews.length === 0) {
        log(`[Ozon] –°—Ç—Ä–∞–Ω–∏—Ü–∞ ${page} –ø—É—Å—Ç–∞, —Å—Ç–æ–ø`);
        break;
      }
      
      allReviews = allReviews.concat(pageReviews);
      log(`[Ozon] –°—Ç—Ä–∞–Ω–∏—Ü–∞ ${page}: ${pageReviews.length} –æ—Ç–∑—ã–≤–æ–≤`);
      
    } catch (e) {
      if (e.message.includes('429')) {
        log(`[Ozon] Rate limit, –∂–¥—ë–º 2 —Å–µ–∫`);
        Utilities.sleep(2000);
        continue;
      }
      log(`[Ozon] –û—à–∏–±–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ${page}: ${e.message}`);
      break;
    }
  }
  
  log(`[Ozon] –°–æ–±—Ä–∞–Ω–æ ${allReviews.length} –æ—Ç–∑—ã–≤–æ–≤`);
  return allReviews;
}

/**
 * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ç–∑—ã–≤–æ–≤ Ozon
 */
function getOzonReviewsPage(store, page) {
  const url = 'https://api-seller.ozon.ru/v1/review/list';
  const options = {
    method: 'post',
    headers: {
      'Client-Id': store.clientId,
      'Api-Key': store.apiKey,
      'Content-Type': 'application/json'
    },
    payload: JSON.stringify({
      page: page,
      page_size: 50 // 50 –æ—Ç–∑—ã–≤–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    }),
    muteHttpExceptions: true
  };
  
  const response = UrlFetchApp.fetch(url, options);
  const result = JSON.parse(response.getContentText());
  
  if (!result.result || !result.result.reviews) {
    return [];
  }
  
  return result.result.reviews.map(r => ({
    id: r.id,
    date: r.created_date || new Date().toISOString(),
    rating: r.score || 0,
    text: r.text || '',
    product: r.product_name || '',
    marketplace: 'Ozon'
  }));
}

/**
 * –°–±–æ—Ä –æ—Ç–∑—ã–≤–æ–≤ Wildberries (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞)
 */
function collectWBReviews(store) {
  const DELAY_MS = 500;
  const last24h = Math.floor(Date.now() / 1000) - (24 * 60 * 60);
  
  log(`[WB] –°–±–æ—Ä –¥–ª—è ${store.name}, –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24h`);
  
  try {
    Utilities.sleep(DELAY_MS);
    
    const url = `https://feedbacks-api.wildberries.ru/api/v1/feedbacks?dateFrom=${last24h}&take=5000`;
    const options = {
      method: 'get',
      headers: {
        'Authorization': store.apiKey
      },
      muteHttpExceptions: true
    };
    
    const response = UrlFetchApp.fetch(url, options);
    const result = JSON.parse(response.getContentText());
    
    const reviews = (result.data?.feedbacks || []).map(r => ({
      id: r.id,
      date: r.createdDate || new Date().toISOString(),
      rating: r.productValuation || 0,
      text: r.text || '',
      product: r.productDetails?.productName || '',
      marketplace: 'Wildberries'
    }));
    
    log(`[WB] –°–æ–±—Ä–∞–Ω–æ ${reviews.length} –æ—Ç–∑—ã–≤–æ–≤`);
    return reviews;
    
  } catch (e) {
    log(`[WB] –û—à–∏–±–∫–∞: ${e.message}`);
    return [];
  }
}

/**
 * –ö–†–ò–¢–ò–ß–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ Properties
 */
function filterDuplicatesByProperties(newReviews, storeId) {
  const props = PropertiesService.getScriptProperties();
  const key = `reviewIds_${storeId}`;
  
  // –ü–æ–ª—É—á–∞–µ–º –∫–µ—à ID
  const cachedIds = JSON.parse(props.getProperty(key) || '[]');
  const cachedSet = new Set(cachedIds);
  
  // –§–∏–ª—å—Ç—Ä—É–µ–º
  const uniqueReviews = newReviews.filter(r => !cachedSet.has(r.id));
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∫–µ—à
  if (uniqueReviews.length > 0) {
    const newIds = uniqueReviews.map(r => r.id);
    const allIds = [...cachedSet, ...newIds];
    
    // –•—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10K ID
    props.setProperty(key, JSON.stringify(allIds.slice(-10000)));
  }
  
  return uniqueReviews;
}

/**
 * Batch —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ª–∏—Å—Ç
 */
function batchSaveToSheet(reviews, storeId) {
  const sheet = getOrCreateStoreSheet(storeId);
  const now = new Date();
  
  const rows = reviews.map(r => [
    r.id,
    r.date,
    r.rating,
    r.text,
    r.product,
    'NEW', // status
    now,   // processedDate
    '',    // answer
    ''     // errorMsg
  ]);
  
  // –û–î–ù–ê –æ–ø–µ—Ä–∞—Ü–∏—è setValues
  sheet.getRange(sheet.getLastRow() + 1, 1, rows.length, 9).setValues(rows);
}

function getOrCreateStoreSheet(storeId) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(storeId);
  
  if (!sheet) {
    sheet = ss.insertSheet(storeId);
    sheet.getRange(1, 1, 1, 9).setValues([[
      'reviewId', 'createdDate', 'rating', 'text', 'product',
      'status', 'processedDate', 'answer', 'errorMsg'
    ]]);
  }
  
  return sheet;
}

function getActiveStores() {
  // –ó–∞–≥–ª—É—à–∫–∞ - –∑–∞–º–µ–Ω–∏ –Ω–∞ —á—Ç–µ–Ω–∏–µ –∏–∑ –ª–∏—Å—Ç–∞ "Stores"
  return [
    { id: 'ozon_001', name: '–ú–∞–≥–∞–∑–∏–Ω 1 Ozon', marketplace: 'Ozon', clientId: 'xxx', apiKey: 'yyy' },
    { id: 'wb_001', name: '–ú–∞–≥–∞–∑–∏–Ω 1 WB', marketplace: 'Wildberries', apiKey: 'zzz' }
  ];
}
```

---

### 2Ô∏è‚É£ –¢–†–ò–ì–ì–ï–† 2: –ü–û–î–ë–û–† –û–¢–í–ï–¢–û–í (–∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞)

```javascript
/**
 * –ü–æ–¥–±–æ—Ä –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –Ω–æ–≤—ã—Ö –æ—Ç–∑—ã–≤–æ–≤
 */
function selectReviewAnswers() {
  log('[Selector] üöÄ –ù–∞—á–∞–ª–æ –ø–æ–¥–±–æ—Ä–∞');
  
  const newReviews = getAllReviewsByStatus('NEW', 100);
  
  if (newReviews.length === 0) {
    log('[Selector] ‚ÑπÔ∏è –ù–æ–≤—ã—Ö –æ—Ç–∑—ã–≤–æ–≤ –Ω–µ—Ç');
    return;
  }
  
  log(`[Selector] üìä –ù–∞–π–¥–µ–Ω–æ ${newReviews.length} –æ—Ç–∑—ã–≤–æ–≤`);
  
  const updates = [];
  
  newReviews.forEach(review => {
    try {
      // –í—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞ –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É
      let template = '';
      
      switch(review.rating) {
        case 5:
          template = 'üåü –°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–ª–∏—á–Ω—ã–π –æ—Ç–∑—ã–≤! –†–∞–¥—ã, —á—Ç–æ –≤–∞–º –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å!';
          break;
        case 4:
          template = 'üëç –ë–ª–∞–≥–æ–¥–∞—Ä–∏–º –∑–∞ –æ—Ü–µ–Ω–∫—É! –í–∞—à–µ –º–Ω–µ–Ω–∏–µ –æ—á–µ–Ω—å –≤–∞–∂–Ω–æ –¥–ª—è –Ω–∞—Å.';
          break;
        case 3:
          template = 'üí≠ –°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É—á—Ç—ë–º –≤–∞—à–∏ –∑–∞–º–µ—á–∞–Ω–∏—è.';
          break;
        case 2:
        case 1:
          template = 'üòî –ò–∑–≤–∏–Ω–∏—Ç–µ –∑–∞ —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã.';
          break;
        default:
          template = '–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤!';
      }
      
      // –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
      if (review.text) {
        const text = review.text.toLowerCase();
        
        if (text.includes('–¥–æ—Å—Ç–∞–≤–∫–∞') || text.includes('–∫—É—Ä—å–µ—Ä')) {
          template += '\nüì¶ –ü–æ –≤–æ–ø—Ä–æ—Å–∞–º –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏.';
        }
        
        if (text.includes('–∫–∞—á–µ—Å—Ç–≤–æ') || text.includes('–±—Ä–∞–∫')) {
          template += '\nüîß –ì–æ—Ç–æ–≤—ã –ø–æ–º–æ—á—å —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º –∏–ª–∏ –∑–∞–º–µ–Ω–æ–π —Ç–æ–≤–∞—Ä–∞.';
        }
        
        if (text.includes('—Ü–µ–Ω–∞') || text.includes('–¥–æ—Ä–æ–≥–æ')) {
          template += '\nüí∞ –°–ª–µ–¥–∏—Ç–µ –∑–∞ –Ω–∞—à–∏–º–∏ –∞–∫—Ü–∏—è–º–∏ –∏ —Å–∫–∏–¥–∫–∞–º–∏!';
        }
      }
      
      updates.push({
        ...review,
        answer: template,
        status: 'PENDING_SEND',
        processedDate: new Date()
      });
      
    } catch (e) {
      log(`[Selector] ‚ùå –û—à–∏–±–∫–∞ ${review.id}: ${e}`);
    }
  });
  
  if (updates.length > 0) {
    batchUpdateReviews(updates);
    log(`[Selector] ‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${updates.length}`);
  }
}
```

---

### 3Ô∏è‚É£ –¢–†–ò–ì–ì–ï–† 3: –û–¢–ü–†–ê–í–ö–ê –û–¢–í–ï–¢–û–í (–∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞)

```javascript
/**
 * –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –æ—Ç–∑—ã–≤—ã
 */
function sendReviewAnswers() {
  log('[Sender] üöÄ –ù–∞—á–∞–ª–æ –æ—Ç–ø—Ä–∞–≤–∫–∏');
  
  const pendingReviews = getAllReviewsByStatus('PENDING_SEND', 50);
  
  if (pendingReviews.length === 0) {
    log('[Sender] ‚ÑπÔ∏è –û—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–µ—Ç');
    return;
  }
  
  log(`[Sender] üìä –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ${pendingReviews.length}`);
  
  const updates = [];
  
  pendingReviews.forEach(review => {
    try {
      let success = false;
      
      if (review.marketplace === 'Ozon') {
        success = sendOzonAnswer(review);
        Utilities.sleep(500); // Rate limit Ozon
      } else if (review.marketplace === 'Wildberries') {
        success = sendWBAnswer(review);
        Utilities.sleep(333); // Rate limit WB
      }
      
      updates.push({
        ...review,
        status: success ? 'SENT' : 'ERROR',
        errorMsg: success ? '' : '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏'
      });
      
      log(`[Sender] ${success ? '‚úÖ' : '‚ùå'} ${review.id}`);
      
    } catch (e) {
      log(`[Sender] ‚ùå Exception ${review.id}: ${e}`);
      updates.push({
        ...review,
        status: 'ERROR',
        errorMsg: e.toString()
      });
    }
  });
  
  if (updates.length > 0) {
    batchUpdateReviews(updates);
  }
}

/**
 * –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –æ—Ç–∑—ã–≤ Ozon
 */
function sendOzonAnswer(review) {
  const store = getStoreById(review.storeId);
  
  const url = 'https://api-seller.ozon.ru/v1/review/create-answer';
  const options = {
    method: 'post',
    headers: {
      'Client-Id': store.clientId,
      'Api-Key': store.apiKey,
      'Content-Type': 'application/json'
    },
    payload: JSON.stringify({
      review_id: review.id,
      text: review.answer
    }),
    muteHttpExceptions: true
  };
  
  try {
    const response = UrlFetchApp.fetch(url, options);
    const result = JSON.parse(response.getContentText());
    return result.result === true;
  } catch (e) {
    log(`[Ozon API] –û—à–∏–±–∫–∞: ${e.message}`);
    return false;
  }
}

/**
 * –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –æ—Ç–∑—ã–≤ WB
 */
function sendWBAnswer(review) {
  const store = getStoreById(review.storeId);
  
  const url = `https://feedbacks-api.wildberries.ru/api/v1/feedbacks/${review.id}`;
  const options = {
    method: 'patch',
    headers: {
      'Authorization': store.apiKey,
      'Content-Type': 'application/json'
    },
    payload: JSON.stringify({
      text: review.answer
    }),
    muteHttpExceptions: true
  };
  
  try {
    const response = UrlFetchApp.fetch(url, options);
    return response.getResponseCode() === 200;
  } catch (e) {
    log(`[WB API] –û—à–∏–±–∫–∞: ${e.message}`);
    return false;
  }
}
```

---

### 4Ô∏è‚É£ HELPER –§–£–ù–ö–¶–ò–ò

```javascript
/**
 * –ü–æ–∏—Å–∫ –æ—Ç–∑—ã–≤–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å—É –∏–∑ –≤—Å–µ—Ö –ª–∏—Å—Ç–æ–≤
 */
function getAllReviewsByStatus(status, limit) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = ss.getSheets();
  let allReviews = [];
  
  sheets.forEach(sheet => {
    const name = sheet.getName();
    if (name === 'Stores' || name === 'Settings' || name === 'Logs') return;
    
    const data = sheet.getDataRange().getValues();
    
    for (let i = 1; i < data.length && allReviews.length < limit; i++) {
      if (data[i][5] === status) {
        allReviews.push({
          sheetName: name,
          storeId: name,
          rowIndex: i + 1,
          id: data[i][0],
          date: data[i][1],
          rating: data[i][2],
          text: data[i][3],
          product: data[i][4],
          status: data[i][5],
          processedDate: data[i][6],
          answer: data[i][7],
          errorMsg: data[i][8],
          marketplace: name.split('_')[0]
        });
      }
    }
  });
  
  return allReviews.slice(0, limit);
}

/**
 * Batch –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–æ–≤
 */
function batchUpdateReviews(updates) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grouped = {};
  
  updates.forEach(u => {
    if (!grouped[u.sheetName]) grouped[u.sheetName] = [];
    grouped[u.sheetName].push(u);
  });
  
  Object.entries(grouped).forEach(([sheetName, sheetUpdates]) => {
    const sheet = ss.getSheetByName(sheetName);
    
    sheetUpdates.forEach(u => {
      sheet.getRange(u.rowIndex, 6, 1, 4).setValues([[
        u.status,
        u.processedDate || new Date(),
        u.answer || '',
        u.errorMsg || ''
      ]]);
    });
  });
}

/**
 * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
 */
function log(msg) {
  console.log(msg);
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const logSheet = ss.getSheetByName('Logs') || ss.insertSheet('Logs');
  logSheet.appendRow([new Date(), msg]);
}

function getStoreById(storeId) {
  // –ó–∞–≥–ª—É—à–∫–∞ - —Ä–µ–∞–ª–∏–∑—É–π —á—Ç–µ–Ω–∏–µ –∏–∑ –ª–∏—Å—Ç–∞ "Stores"
  return { id: storeId, clientId: 'xxx', apiKey: 'yyy' };
}
```

---

## üöÄ –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –†–ê–ó–í–Å–†–¢–´–í–ê–ù–ò–Æ

### –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ Google Sheets

1. –°–æ–∑–¥–∞–π –Ω–æ–≤—É—é Google –¢–∞–±–ª–∏—Ü—É
2. –°–æ–∑–¥–∞–π –ª–∏—Å—Ç—ã:
   - **Stores** (–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–∞–≥–∞–∑–∏–Ω–æ–≤)
   - **Settings** (—à–∞–±–ª–æ–Ω—ã –æ—Ç–≤–µ—Ç–æ–≤)
   - **Logs** (–ª–æ–≥–∏)
3. –í –ª–∏—Å—Ç–µ **Stores** —Å–æ–∑–¥–∞–π –∑–∞–≥–æ–ª–æ–≤–∫–∏:
   ```
   | id | name | marketplace | clientId | apiKey | isActive |
   ```

### –®–∞–≥ 2: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞

1. Extensions ‚Üí Apps Script
2. –°–∫–æ–ø–∏—Ä—É–π –≤–µ—Å—å –∫–æ–¥ –≤—ã—à–µ –≤ `Code.gs`
3. –°–æ—Ö—Ä–∞–Ω–∏ (Ctrl+S)

### –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤

1. –í Apps Script: Triggers (—á–∞—Å—ã —Å–ª–µ–≤–∞)
2. Add Trigger:
   - **–¢—Ä–∏–≥–≥–µ—Ä 1**: `hourlyReviewCollector` ‚Üí Time-driven ‚Üí Hours timer ‚Üí Every 2 hours
   - **–¢—Ä–∏–≥–≥–µ—Ä 2**: `selectReviewAnswers` ‚Üí Time-driven ‚Üí Hours timer ‚Üí Every 2 hours
   - **–¢—Ä–∏–≥–≥–µ—Ä 3**: `sendReviewAnswers` ‚Üí Time-driven ‚Üí Hours timer ‚Üí Every 2 hours
3. Authorize (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫)

### –®–∞–≥ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –ó–∞–ø–æ–ª–Ω–∏ –ª–∏—Å—Ç **Stores** –¥–∞–Ω–Ω—ã–º–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤
2. –ó–∞–ø—É—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é `hourlyReviewCollector()`
3. –ü—Ä–æ–≤–µ—Ä—å –ø–æ—è–≤–ª–µ–Ω–∏–µ –ª–∏—Å—Ç–æ–≤ —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤
4. –ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å—ã –æ—Ç–∑—ã–≤–æ–≤

---

## üìä –§–ò–ù–ê–õ–¨–ù–´–ï –¶–ò–§–†–´

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| **–°—Ç–æ–∏–º–æ—Å—Ç—å** | 0 ‚ÇΩ (100% –±–µ—Å–ø–ª–∞—Ç–Ω–æ) |
| **Runtime/–¥–µ–Ω—å** | 60 –º–∏–Ω—É—Ç (–∏–∑ 90) ‚úÖ |
| **–¢—Ä–∏–≥–≥–µ—Ä—ã** | 3 (–∏–∑ 20) |
| **–ú–∞–≥–∞–∑–∏–Ω–æ–≤** | –î–æ 15 (10 Ozon + 5 WB) |
| **–û—Ç–∑—ã–≤–æ–≤/–¥–µ–Ω—å** | ~500-1000 |
| **–î—É–±–ª–∏–∫–∞—Ç—ã** | ‚ùå –ò—Å–∫–ª—é—á–µ–Ω—ã (Properties –∫–µ—à) |

---

## üéØ –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê –§–ò–ù–ê–õ–¨–ù–û–ì–û –ü–õ–ê–ù–ê

‚úÖ **100% –±–µ—Å–ø–ª–∞—Ç–Ω–æ** ‚Äî –Ω–∏–∫–∞–∫–∏—Ö –ø–ª–∞—Ç–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤  
‚úÖ **Properties –∫–µ—à** ‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤  
‚úÖ **Batch operations** ‚Äî –±—ã—Å—Ç—Ä–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Sheets  
‚úÖ **State machine** ‚Äî –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±–æ–µ–≤  
‚úÖ **Rate limiting** ‚Äî —Å–æ–±–ª—é–¥–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ API  
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** ‚Äî –¥–æ 15 –º–∞–≥–∞–∑–∏–Ω–æ–≤ –Ω–∞ Consumer  
‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞** ‚Äî –≤—Å—ë –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ (Apps Script)  

---

## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ó–ê–ú–ï–ß–ê–ù–ò–Ø

1. **Properties –∫–µ—à –∫—Ä–∏—Ç–∏—á–µ–Ω** ‚Äî –±–µ–∑ –Ω–µ–≥–æ –±—É–¥–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–æ
2. **–ò–Ω—Ç–µ—Ä–≤–∞–ª 2 —á–∞—Å–∞** ‚Äî –¥–ª—è —É–∫–ª–∞–¥—ã–≤–∞–Ω–∏—è –≤ 90 –º–∏–Ω—É—Ç runtime
3. **20 —Å—Ç—Ä–∞–Ω–∏—Ü Ozon** ‚Äî –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞, –ø–æ—Ç–æ–º –Ω–æ–≤—ã–µ –Ω–∞ –ø–µ—Ä–≤—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö
4. **WB –∑–∞ 24 —á–∞—Å–∞** ‚Äî –Ω–∞–¥—ë–∂–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∞—Ç–µ
5. **–ó–∞–≥–ª—É—à–∫–∏ API** ‚Äî –∑–∞–º–µ–Ω–∏ `getStoreById()` –∏ –ø–æ–¥–æ–±–Ω—ã–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ

---

**–í–µ—Ä—Å–∏—è**: 5.0.0  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ Production-ready –ë–ï–ó APIMonster  
**–î–∞—Ç–∞**: 24 –æ–∫—Ç—è–±—Ä—è 2025
