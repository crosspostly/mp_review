name: üöÄ Deploy to Google Apps Script

on:
  push:
    branches: [ main ]
    paths:
      - 'refactor/**'
      - 'appsscript.json'
      - '.clasp.json'
  workflow_dispatch:

jobs:
  deploy:
    name: üöÄ Deploy to GAS
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout –∫–æ–¥–∞
      uses: actions/checkout@v4
      
    - name: üîß Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: üì¶ Install clasp
      run: |
        npm install -g @google/clasp
        echo "‚úÖ clasp —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        clasp --version
        
    - name: üîë Setup clasp credentials
      run: |
        echo "üîë ===== –ù–ê–°–¢–†–û–ô–ö–ê CREDENTIALS ====="
        echo ""
        
        # –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–µ–∫—Ä–µ—Ç–∞
        echo "üìã –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–µ–∫—Ä–µ—Ç–∞ CLASP_CREDENTIALS..."
        if [ -z "${{ secrets.CLASP_CREDENTIALS }}" ]; then
          echo "‚ùå –û–®–ò–ë–ö–ê: –°–µ–∫—Ä–µ—Ç CLASP_CREDENTIALS –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          echo ""
          echo "üîß –ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:"
          echo "1. –ù–∞ —Å–≤–æ–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: clasp login"
          echo "2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ ~/.clasprc.json"
          echo "3. –û—Ç–∫—Ä–æ–π—Ç–µ: https://github.com/${{ github.repository }}/settings/secrets/actions"
          echo "4. –ù–∞–∂–º–∏—Ç–µ 'New repository secret'"
          echo "5. Name: CLASP_CREDENTIALS"
          echo "6. Value: –í—Å—Ç–∞–≤—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ .clasprc.json"
          echo "7. –ù–∞–∂–º–∏—Ç–µ 'Add secret'"
          echo ""
          exit 1
        fi
        echo "‚úÖ –°–µ–∫—Ä–µ—Ç CLASP_CREDENTIALS –Ω–∞–π–¥–µ–Ω"
        echo ""
        
        # –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ JSON
        echo "üìã –®–∞–≥ 2: –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ JSON..."
        if ! echo '${{ secrets.CLASP_CREDENTIALS }}' | jq . > /dev/null 2>&1; then
          echo "‚ùå –û–®–ò–ë–ö–ê: CLASP_CREDENTIALS –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º JSON!"
          echo ""
          echo "üîß –ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:"
          echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–∏ –í–ï–°–¨ JSON —Ü–µ–ª–∏–∫–æ–º –∏–∑ ~/.clasprc.json"
          echo "2. JSON –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å { –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –Ω–∞ }"
          echo "3. –£–¥–∞–ª–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç –∏ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–Ω–æ–≤–æ"
          echo ""
          exit 1
        fi
        echo "‚úÖ JSON –≤–∞–ª–∏–¥–µ–Ω"
        echo ""
        
        # –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã OAuth —Ç–æ–∫–µ–Ω–∞
        echo "üìã –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã OAuth —Ç–æ–∫–µ–Ω–∞..."
        
        HAS_TOKEN=$(echo '${{ secrets.CLASP_CREDENTIALS }}' | jq -r '.token // empty')
        HAS_OAUTH=$(echo '${{ secrets.CLASP_CREDENTIALS }}' | jq -r '.oauth2ClientSettings // empty')
        
        if [ -z "$HAS_TOKEN" ]; then
          echo "‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ 'token'"
          echo "–≠—Ç–æ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å OAuth —Ç–æ–∫–µ–Ω –∏–∑ clasp login"
        else
          echo "‚úÖ token –Ω–∞–π–¥–µ–Ω"
          
          ACCESS_TOKEN=$(echo '${{ secrets.CLASP_CREDENTIALS }}' | jq -r '.token.access_token // empty')
          REFRESH_TOKEN=$(echo '${{ secrets.CLASP_CREDENTIALS }}' | jq -r '.token.refresh_token // empty')
          
          if [ -n "$ACCESS_TOKEN" ]; then
            echo "‚úÖ access_token: [PRESENT]"
          fi
          
          if [ -n "$REFRESH_TOKEN" ]; then
            echo "‚úÖ refresh_token: [PRESENT]"
          fi
        fi
        
        if [ -n "$HAS_OAUTH" ]; then
          CLIENT_ID=$(echo '${{ secrets.CLASP_CREDENTIALS }}' | jq -r '.oauth2ClientSettings.clientId // empty')
          echo "‚úÖ oauth2ClientSettings –Ω–∞–π–¥–µ–Ω—ã"
          if [ -n "$CLIENT_ID" ]; then
            echo "‚úÖ clientId: ${CLIENT_ID:0:20}..."
          fi
        fi
        echo ""
        
        # –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ .clasprc.json
        echo "üìã –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ .clasprc.json..."
        echo '${{ secrets.CLASP_CREDENTIALS }}' > ~/.clasprc.json
        
        if [ ! -f ~/.clasprc.json ]; then
          echo "‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å ~/.clasprc.json"
          exit 1
        fi
        
        FILE_SIZE=$(wc -c < ~/.clasprc.json)
        echo "‚úÖ –§–∞–π–ª ~/.clasprc.json —Å–æ–∑–¥–∞–Ω (—Ä–∞–∑–º–µ—Ä: $FILE_SIZE –±–∞–π—Ç)"
        echo ""
        
        # –®–∞–≥ 5: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        echo "üìã –®–∞–≥ 5: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
        if jq . ~/.clasprc.json > /dev/null 2>&1; then
          echo "‚úÖ Credentials —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã!"
        else
          echo "‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª ~/.clasprc.json –ø–æ–≤—Ä–µ–∂–¥–µ–Ω"
          exit 1
        fi
        echo ""
        
        # –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ access token —á–µ—Ä–µ–∑ refresh token
        echo "üìã –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∞..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º expiry_date
        EXPIRY=$(jq -r '.token.expiry_date // 0' ~/.clasprc.json)
        CURRENT_TIME=$(date +%s)000  # –ú–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
        
        if [ "$EXPIRY" -lt "$CURRENT_TIME" ]; then
          echo "‚ö†Ô∏è Access token –∏—Å—Ç–µ–∫ (expiry: $EXPIRY, current: $CURRENT_TIME)"
          echo "üîÑ –¢–æ–∫–µ–Ω –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–µ–∑ refresh_token –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ clasp"
        else
          echo "‚úÖ Access token –∞–∫—Ç—É–∞–ª–µ–Ω"
          TIME_LEFT=$(( ($EXPIRY - $CURRENT_TIME) / 1000 / 60 ))
          echo "‚è∞ –û—Å—Ç–∞–ª–æ—Å—å: ~$TIME_LEFT –º–∏–Ω—É—Ç"
        fi
        echo ""
        
        echo "‚úÖ ===== CREDENTIALS –ì–û–¢–û–í–´ ====="
        
    - name: üìã Verify configuration
      run: |
        echo "üìã ===== –ü–†–û–í–ï–†–ö–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò ====="
        echo ""
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ .clasp.json
        echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ .clasp.json..."
        if [ ! -f ".clasp.json" ]; then
          echo "‚ùå –û–®–ò–ë–ö–ê: .clasp.json –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          echo ""
          echo "üîß –ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:"
          echo "1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª .clasp.json –µ—Å—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏"
          echo "2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É"
          echo ""
          exit 1
        fi
        
        echo "‚úÖ –§–∞–π–ª .clasp.json –Ω–∞–π–¥–µ–Ω"
        echo ""
        echo "üìÑ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ .clasp.json:"
        cat .clasp.json
        echo ""
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è .clasp.json
        echo "üìã –í–∞–ª–∏–¥–∞—Ü–∏—è .clasp.json..."
        if ! jq . .clasp.json > /dev/null 2>&1; then
          echo "‚ùå –û–®–ò–ë–ö–ê: .clasp.json –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º JSON!"
          exit 1
        fi
        
        SCRIPT_ID=$(jq -r '.scriptId // empty' .clasp.json)
        ROOT_DIR=$(jq -r '.rootDir // empty' .clasp.json)
        
        if [ -z "$SCRIPT_ID" ]; then
          echo "‚ùå –û–®–ò–ë–ö–ê: scriptId –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ .clasp.json"
          exit 1
        fi
        
        echo "‚úÖ scriptId: $SCRIPT_ID"
        
        if [ -n "$ROOT_DIR" ]; then
          echo "‚úÖ rootDir: $ROOT_DIR"
          
          if [ ! -d "$ROOT_DIR" ]; then
            echo "‚ùå –û–®–ò–ë–ö–ê: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $ROOT_DIR –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
            exit 1
          fi
          
          echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $ROOT_DIR —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
        fi
        echo ""
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ appsscript.json
        echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ appsscript.json..."
        if [ ! -f "appsscript.json" ]; then
          echo "‚ùå –û–®–ò–ë–ö–ê: appsscript.json –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          echo ""
          echo "üîß –ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:"
          echo "1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª appsscript.json –µ—Å—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏"
          echo "2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É"
          echo ""
          exit 1
        fi
        
        echo "‚úÖ –§–∞–π–ª appsscript.json –Ω–∞–π–¥–µ–Ω"
        echo ""
        echo "üìÑ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ appsscript.json:"
        cat appsscript.json
        echo ""
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è appsscript.json
        echo "üìã –í–∞–ª–∏–¥–∞—Ü–∏—è appsscript.json..."
        if ! jq . appsscript.json > /dev/null 2>&1; then
          echo "‚ùå –û–®–ò–ë–ö–ê: appsscript.json –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º JSON!"
          exit 1
        fi
        
        echo "‚úÖ appsscript.json –≤–∞–ª–∏–¥–µ–Ω"
        echo ""
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
        if [ -n "$ROOT_DIR" ]; then
          echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –≤ $ROOT_DIR..."
          GS_FILES=$(find "$ROOT_DIR" -name "*.gs" 2>/dev/null | wc -l)
          HTML_FILES=$(find "$ROOT_DIR" -name "*.html" 2>/dev/null | wc -l)
          
          echo "üìä –ù–∞–π–¥–µ–Ω–æ .gs —Ñ–∞–π–ª–æ–≤: $GS_FILES"
          echo "üìä –ù–∞–π–¥–µ–Ω–æ .html —Ñ–∞–π–ª–æ–≤: $HTML_FILES"
          
          if [ $GS_FILES -eq 0 ] && [ $HTML_FILES -eq 0 ]; then
            echo "‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏!"
          fi
          echo ""
        fi
        
        echo "‚úÖ ===== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ü–†–û–í–ï–†–ï–ù–ê ====="
        
    - name: üì§ Push to Google Apps Script
      run: |
        echo "üì§ ===== –ó–ê–ì–†–£–ó–ö–ê –í GOOGLE APPS SCRIPT ====="
        echo ""
        
        echo "üìã –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–∞–≥—Ä—É–∑–∫–µ..."
        echo "üéØ Target Script ID: $(jq -r '.scriptId' .clasp.json)"
        echo "üìÅ Source directory: $(jq -r '.rootDir // "."' .clasp.json)"
        echo ""
        
        # –ü–æ–ø—ã—Ç–∫–∞ push —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
        echo "üì§ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ clasp push --force..."
        echo ""
        
        if clasp push --force 2>&1 | tee /tmp/clasp_push.log; then
          echo ""
          echo "‚úÖ Push –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
          echo ""
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –±—ã–ª–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
          echo "üìä –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:"
          if [ -f /tmp/clasp_push.log ]; then
            grep "‚îî‚îÄ" /tmp/clasp_push.log || echo "  (–¥–µ—Ç–∞–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã)"
          fi
        else
          echo ""
          echo "‚ùå –û–®–ò–ë–ö–ê: Push –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è!"
          echo ""
          
          # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
          if grep -q "Permission denied" /tmp/clasp_push.log 2>/dev/null; then
            echo "üîß –ü—Ä–∏—á–∏–Ω–∞: –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–æ–µ–∫—Ç—É"
            echo ""
            echo "–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:"
            echo "1. –û—Ç–∫—Ä–æ–π—Ç–µ: https://script.google.com"
            echo "2. –ù–∞–π–¥–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç —Å Script ID: $(jq -r '.scriptId' .clasp.json)"
            echo "3. –ù–∞–∂–º–∏—Ç–µ Share"
            echo "4. –î–æ–±–∞–≤—å—Ç–µ: $(jq -r '.client_email' ~/.clasprc.json)"
            echo "5. –ü—Ä–∞–≤–∞: Editor"
          elif grep -q "User has not enabled" /tmp/clasp_push.log 2>/dev/null; then
            echo "üîß –ü—Ä–∏—á–∏–Ω–∞: Apps Script API –Ω–µ –≤–∫–ª—é—á–µ–Ω"
            echo ""
            echo "–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:"
            echo "1. –û—Ç–∫—Ä–æ–π—Ç–µ: https://console.cloud.google.com/apis/library/script.googleapis.com"
            echo "2. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç: $(jq -r '.project_id' ~/.clasprc.json)"
            echo "3. –ù–∞–∂–º–∏—Ç–µ ENABLE"
          elif grep -q "not found" /tmp/clasp_push.log 2>/dev/null; then
            echo "üîß –ü—Ä–∏—á–∏–Ω–∞: –ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"
            echo ""
            echo "–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:"
            echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Script ID –≤ .clasp.json"
            echo "2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–æ–µ–∫—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ https://script.google.com"
          else
            echo "üîß –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"
            echo ""
            echo "–õ–æ–≥ –æ—à–∏–±–∫–∏:"
            cat /tmp/clasp_push.log
          fi
          echo ""
          exit 1
        fi
        
        echo ""
        echo "‚úÖ ===== –ö–û–î –£–°–ü–ï–®–ù–û –ó–ê–ì–†–£–ñ–ï–ù ====="
        
    - name: üìä Deployment info
      run: |
        echo "üìä ===== –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –î–ï–ü–õ–û–ï ====="
        echo "üïê –í—Ä–µ–º—è: $(date)"
        echo "üìù –ö–æ–º–º–∏—Ç: ${{ github.sha }}"
        echo "üë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}"
        echo "üåø –í–µ—Ç–∫–∞: ${{ github.ref_name }}"
        echo "üéØ Script ID: $(grep scriptId .clasp.json | cut -d'"' -f4)"
        echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
