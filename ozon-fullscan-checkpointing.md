# Full Ozon First-Time Scan: Multi-Session Checkpointing

Цель: безопасно просканировать ТЫСЯЧИ страниц Ozon при первом запуске, не нарушая лимит 6 минут GAS, с гарантией продолжения с места остановки.

Ключевая идея: разрезаем полный скан на «сессии» по 5.5 минуты. Каждая сессия сканирует фиксированный «чанк» страниц (например, 300), сохраняет чекпоинт, и выходит. Следующий ручной запуск продолжает с чекпоинта. При этом все новые ID заносятся в кеш, исключая дубли.

Структура checkpoint в Properties (на магазин):
- ozon_fullscan_active_{storeId} = true|false — идет ли полное сканирование
- ozon_fullscan_last_id_{storeId} = string — last_id текущей позиции
- ozon_fullscan_pages_scanned_{storeId} = number — сколько страниц просканировано за все сессии
- ozon_fullscan_total_collected_{storeId} = number — сколько отзывов собрано
- reviewIds_{storeId} = JSON массив ID (кеш дублей)

Алгоритм одной сессии:
1) Если ozon_fullscan_active != true — установить true и обнулить счетчики.
2) Считать last_id (пусто для старта), pages_scanned, total_collected.
3) В цикле: дергать /v1/review/list с limit=100 и last_id, пока не достигнут лимит времени 5.5 мин или пустая страница.
4) После каждой страницы:
   - обновить last_id = id последнего отзыва на странице
   - увеличить pages_scanned
   - отфильтровать дубли по кешу reviewIds_{storeId}, сохранить только новые
   - дозаписать новые в таблицу и добавить их ID в кеш
5) Перед выходом: обновить checkpoint в Properties (last_id, pages_scanned, total_collected). Если пустая страница — пометить ozon_fullscan_active=false.

Почему это безопасно:
- Всегда укладываемся в 6 минут (жесткая проверка времени до каждого запроса)
- Не дублируем записи (кеш ID)
- Можно запускать хоть 20 раз подряд — дойдет до конца базы даже при тысячах страниц

Интерфейс:
- Кнопка «Продолжить ПОЛНЫЙ СБОР (Ozon)» — запускает одну сессию
- Текстовый прогресс (страниц просканировано, собрано отзывов)

Приоритеты:
- Сначала полный сбор делает глубокий бэкап базы. Потом система перейдет на инкрементальные «полоски».

